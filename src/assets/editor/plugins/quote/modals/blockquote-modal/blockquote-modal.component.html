<dialog #dialog class="blockquote-modal" (close)="cancel()">
  <div class="modal-container">
    <!-- Заголовок -->
    <div class="modal-header">
      <h2>Вставить цитату</h2>
      <button class="close-btn" type="button" (click)="cancel()" title="Закрыть">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Сообщения об ошибках и успехе -->
    <div class="messages" *ngIf="errorMessage || successMessage">
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
      <div class="success-message" *ngIf="successMessage">
        {{ successMessage }}
      </div>
    </div>

    <!-- Вкладки -->
    <div class="tabs">
      <button class="tab-btn" [class.active]="activeTab === 'content'" (click)="switchTab('content')" type="button">
        Содержимое
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'style'" (click)="switchTab('style')" type="button">
        Стиль
      </button>
    </div>

    <!-- Содержимое модального окна -->
    <div class="modal-body">
      <!-- Вкладка "Содержимое" -->
      <div class="tab-content" *ngIf="activeTab === 'content'">
        <form class="quote-form">
          <!-- Текст цитаты -->
          <div class="form-group">
            <label for="quoteText">Текст цитаты *</label>
            <textarea
              #quoteTextarea
              id="quoteText"
              [(ngModel)]="quoteText"
              name="quoteText"
              rows="6"
              placeholder="Введите текст цитаты..."
              required
              [disabled]="isLoading"
            ></textarea>
          </div>

          <!-- Автор -->
          <div class="form-group">
            <label for="author">Автор</label>
            <input
              type="text"
              id="author"
              [(ngModel)]="author"
              name="author"
              placeholder="Например: Альберт Эйнштейн"
              [disabled]="isLoading"
            />
          </div>

          <!-- Источник -->
          <div class="form-group">
            <label for="source">Источник</label>
            <input
              type="text"
              id="source"
              [(ngModel)]="source"
              name="source"
              placeholder="Например: Теория относительности"
              [disabled]="isLoading"
            />
          </div>
        </form>

        <!-- Превью цитаты -->
        <div class="preview-section">
          <h3>Предварительный просмотр</h3>
          <div class="preview-container">
            <blockquote class="aurora-blockquote preview" [ngStyle]="getPreviewStyles()">
              <!-- Before элемент (если есть) -->
              <span
                *ngIf="selectedStyle && selectedStyle.quote.beforeContent"
                class="aurora-blockquote-before"
                [ngStyle]="{
                  content: selectedStyle.quote.beforeContent,
                  position: 'absolute',
                  left: selectedStyle.quote.beforePosition?.left,
                  right: selectedStyle.quote.beforePosition?.right,
                  top: selectedStyle.quote.beforePosition?.top,
                  bottom: selectedStyle.quote.beforePosition?.bottom,
                  fontSize: selectedStyle.quote.beforeFontSize,
                  color: selectedStyle.quote.beforeColor,
                  opacity: selectedStyle.quote.beforeOpacity
                }"
              >
                {{ selectedStyle.quote.beforeContent }}
              </span>

              <p class="aurora-blockquote-text">{{ getPreviewText() }}</p>

              <footer
                *ngIf="getPreviewAuthor() || getPreviewSource()"
                class="aurora-blockquote-footer"
                [ngStyle]="getPreviewFooterStyles()"
              >
                —
                <cite *ngIf="getPreviewSource()">{{ getPreviewSource() }}</cite>
                <span *ngIf="getPreviewSource() && getPreviewAuthor()">, </span>
                <span *ngIf="getPreviewAuthor()">{{ getPreviewAuthor() }}</span>
              </footer>
            </blockquote>
          </div>
        </div>
      </div>

      <!-- Вкладка "Стиль" -->
      <div class="tab-content" *ngIf="activeTab === 'style'">
        <!-- Действия со стилями -->
        <div class="style-actions">
          <button class="btn btn-secondary" type="button" (click)="createNewStyle()" [disabled]="isLoading">
            + Создать стиль
          </button>
          <button
            class="btn btn-secondary"
            type="button"
            (click)="exportStyles()"
            [disabled]="isLoading || isExporting"
          >
            {{ isExporting ? 'Экспорт...' : 'Экспортировать' }}
          </button>
          <button
            class="btn btn-secondary"
            type="button"
            (click)="triggerImport()"
            [disabled]="isLoading || isImporting"
          >
            {{ isImporting ? 'Импорт...' : 'Импортировать' }}
          </button>
          <input #fileInput type="file" accept=".json" class="hidden-input" />
        </div>

        <!-- Список пресетных стилей -->
        <div class="styles-section" *ngIf="presetStyles.length > 0">
          <h3>Готовые стили</h3>
          <div class="styles-list">
            <div *ngFor="let style of presetStyles" [class]="getStyleItemClass(style)" (click)="selectStyle(style.id)">
              <div class="style-preview" [ngStyle]="getBlockquoteCSSObject(style.quote)">
                <p>{{ style.name }}</p>
              </div>
              <div class="style-info">
                <span class="style-name">{{ style.name }}</span>
                <span class="style-badge preset-badge">Пресет</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Список кастомных стилей -->
        <div class="styles-section" *ngIf="customStyles.length > 0">
          <h3>Мои стили</h3>
          <div class="styles-list">
            <div *ngFor="let style of customStyles" [class]="getStyleItemClass(style)">
              <div
                class="style-preview"
                [ngStyle]="getBlockquoteCSSObject(style.quote)"
                (click)="selectStyle(style.id)"
              >
                <p>{{ style.name }}</p>
              </div>
              <div class="style-info">
                <span class="style-name" (click)="selectStyle(style.id)">{{ style.name }}</span>
                <div class="style-actions-inline">
                  <button
                    class="icon-btn"
                    type="button"
                    (click)="editCustomStyle(style)"
                    title="Редактировать"
                    [disabled]="isLoading"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button
                    class="icon-btn"
                    type="button"
                    (click)="duplicateStyle(style)"
                    title="Дублировать"
                    [disabled]="isLoading"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                  </button>
                  <button
                    class="icon-btn danger"
                    type="button"
                    (click)="deleteCustomStyle(style)"
                    title="Удалить"
                    [disabled]="isLoading"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Пустое состояние -->
        <div class="empty-state" *ngIf="customStyles.length === 0 && !isLoading">
          <p>У вас пока нет кастомных стилей</p>
          <button class="btn btn-primary" type="button" (click)="createNewStyle()">Создать первый стиль</button>
        </div>
      </div>
    </div>

    <!-- Футер с кнопками -->
    <div class="modal-footer">
      <button class="btn btn-secondary" type="button" (click)="cancel()" [disabled]="isLoading">Отмена</button>
      <button class="btn btn-primary" type="button" (click)="submit()" [disabled]="!canInsert() || isLoading">
        Вставить цитату
      </button>
    </div>

    <!-- Индикатор загрузки -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="spinner"></div>
    </div>
  </div>
</dialog>
