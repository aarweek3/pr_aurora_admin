# üìã –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ (Watermark) –≤ Image Modal

## 1. –û–ë–ó–û–†

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Ö –≤—Å—Ç–∞–≤–∫–æ–π –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/app/editor/components/image-modal/`

**–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞**: "Watermark" (–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫) –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ "–û–±—Ä–∞–±–æ—Ç–∫–∞" –∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 14 –¥–µ–∫–∞–±—Ä—è 2025 –≥.

**–í–µ—Ä—Å–∏—è**: 1.0

---

## 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### 2.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `image-modal.component.ts`

**–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –≤ activeTab**:

```typescript
activeTab: 'upload' | 'crop' | 'edit' | 'watermark' | 'settings';
```

### 2.2 –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞

**–î–æ–±–∞–≤–∏—Ç—å –≤ ImageData –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**:

```typescript
interface WatermarkConfig {
  enabled: boolean; // –í–∫–ª—é—á–µ–Ω –ª–∏ –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
  type: 'text' | 'image'; // –¢–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (v2)
  text: string; // –¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
  imageUrl?: string; // Data URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-–ª–æ–≥–æ—Ç–∏–ø–∞ (v2)
  imageFile?: File; // –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-–ª–æ–≥–æ—Ç–∏–ø–∞ (v2)
  position: WatermarkPosition; // –ü–æ–∑–∏—Ü–∏—è –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
  fontSize: number; // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px) - –¥–ª—è —Ç–µ–∫—Å—Ç–∞
  imageWidth?: number; // –®–∏—Ä–∏–Ω–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ (px) - –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (v2)
  imageHeight?: number; // –í—ã—Å–æ—Ç–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ (px) - –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (v2)
  fontFamily: string; // –°–µ–º–µ–π—Å—Ç–≤–æ —à—Ä–∏—Ñ—Ç–æ–≤
  color: string; // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (hex –∏–ª–∏ rgba)
  opacity: number; // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (0-100%)
  rotation: number; // –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ (-180 –¥–æ 180)
  offsetX: number; // –°–º–µ—â–µ–Ω–∏–µ –ø–æ X (px)
  offsetY: number; // –°–º–µ—â–µ–Ω–∏–µ –ø–æ Y (px)
}

type WatermarkPosition =
  | 'top-left' // –í–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª
  | 'top-center' // –í–µ—Ä—Ö–Ω–∏–π —Ü–µ–Ω—Ç—Ä
  | 'top-right' // –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª
  | 'center-left' // –¶–µ–Ω—Ç—Ä —Å–ª–µ–≤–∞
  | 'center' // –ü–æ —Ü–µ–Ω—Ç—Ä—É
  | 'center-right' // –¶–µ–Ω—Ç—Ä —Å–ø—Ä–∞–≤–∞
  | 'bottom-left' // –ù–∏–∂–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª
  | 'bottom-center' // –ù–∏–∂–Ω–∏–π —Ü–µ–Ω—Ç—Ä
  | 'bottom-right'; // –ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

---

## 3. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### 3.1 –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

**MVP (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)**:

1. ‚úÖ –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
2. ‚úÖ –í—ã–±–æ—Ä –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ 9 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
3. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
4. ‚úÖ –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç —Å —Ç–µ–Ω—å—é
5. ‚úÖ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ canvas

**–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (v2)**:

1. ‚≠ê **–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å Text/Image** - –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (—Ç–µ–∫—Å—Ç –∏–ª–∏ –ª–æ–≥–æ—Ç–∏–ø)
2. ‚≠ê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ (—Å–ª–∞–π–¥–µ—Ä 12-72px)
3. ‚≠ê –í—ã–±–æ—Ä —à—Ä–∏—Ñ—Ç–∞ (Arial, Times New Roman, Verdana, Georgia, Courier New)
4. ‚≠ê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ (color picker)
5. ‚≠ê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ (—Å–ª–∞–π–¥–µ—Ä 0-100%)
6. ‚≠ê –ü–æ–≤–æ—Ä–æ—Ç —Ç–µ–∫—Å—Ç–∞/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å–ª–∞–π–¥–µ—Ä -180¬∞ –¥–æ 180¬∞)
7. ‚≠ê –†—É—á–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (offsetX, offsetY)
8. ‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–≤–æ–¥–∫–∏/—Ç–µ–Ω–∏ —Ç–µ–∫—Å—Ç–∞
9. ‚≠ê –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —É–∑–æ—Ä (–¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ –ø–æ –≤—Å–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é)
10. ‚≠ê **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-–ª–æ–≥–æ—Ç–∏–ø–∞** –¥–ª—è —Ç–∏–ø–∞ Image

### 3.2 –ê–ª–≥–æ—Ä–∏—Ç–º –Ω–∞–ª–æ–∂–µ–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞

**–ú–µ—Ç–æ–¥**: `private async addWatermark(config: WatermarkConfig): Promise<void>`

**–í–ê–ñ–ù–û**: –ú–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å `imageData.current` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã. –ù–µ —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∫–æ–ø–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!

**–õ–æ–≥–∏–∫–∞**:

```
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ imageData.current —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ metadata –∏–ª–∏ —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π Image)
3. –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:
   - canvas.width = imageWidth
   - canvas.height = imageHeight
4. –ó–∞–≥—Ä—É–∑–∏—Ç—å imageData.current –Ω–∞ canvas
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è:
   - font: `${config.fontSize}px ${config.fontFamily}`
   - fillStyle: config.color (—Å —É—á–µ—Ç–æ–º opacity)
   - textBaseline: 'top' / 'middle' / 'bottom' (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç position)
   - textAlign: 'left' / 'center' / 'right'
6. –í—ã—á–∏—Å–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã x, y –Ω–∞ –æ—Å–Ω–æ–≤–µ position:
   - top-left: (margin, margin)
   - top-center: (width/2, margin)
   - top-right: (width - textWidth - margin, margin)
   - center: (width/2, height/2)
   - bottom-right: (width - textWidth - margin, height - margin)
   - –∏ —Ç.–¥.
7. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (rotate, translate) –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
8. –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ctx.fillText(config.text, x, y)
9. –û–±–Ω–æ–≤–∏—Ç—å imageData.current = canvas.toDataURL('image/png')
10. –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é: addOperation('watermark', config, imageData.current)
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**:

- ‚úÖ –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å `imageData.current`
- ‚úÖ –ú–µ—Ç–æ–¥ –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è Undo/Redo
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π canvas –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏, –∑–∞—Ç–µ–º —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è

### 3.3 –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞

**–§–æ—Ä–º—É–ª–∞** (–∏–∑ –ø—Ä–∏–º–µ—Ä–∞):

```typescript
const fontSize = Math.max(24, Math.min(imageWidth / 20, 48));
```

**–õ–æ–≥–∏–∫–∞**:

- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 24px
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 48px
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π: —à–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è / 20

**–î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏**:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ —Å–ª–∞–π–¥–µ—Ä
- –ù–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3.4 –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å Text/Image (v2)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ - —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏–ª–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π (–ª–æ–≥–æ—Ç–∏–ø).

**UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**:

```html
<div class="watermark-type-selector">
  <button [class.active]="watermarkConfig.type === 'text'" (click)="setWatermarkType('text')">
    üìù Text
  </button>
  <button [class.active]="watermarkConfig.type === 'image'" (click)="setWatermarkType('image')">
    üñºÔ∏è Image
  </button>
</div>
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:

1. **–ü—Ä–∏ –≤—ã–±–æ—Ä–µ "Text"** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):

   - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è: —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, color picker, —Å–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞, dropdown —à—Ä–∏—Ñ—Ç–∞
   - –°–∫—Ä—ã–≤–∞—é—Ç—Å—è: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–ª–∞–π–¥–µ—Ä—ã —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ—Ç–∏–ø–∞

2. **–ü—Ä–∏ –≤—ã–±–æ—Ä–µ "Image"**:
   - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è: –∫–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø", —Å–ª–∞–π–¥–µ—Ä—ã —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ (width/height)
   - –°–∫—Ä—ã–≤–∞—é—Ç—Å—è: —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, color picker, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞
   - –û–±—â–∏–µ –¥–ª—è –æ–±–æ–∏—Ö: –ø–æ–∑–∏—Ü–∏—è, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –ø–æ–≤–æ—Ä–æ—Ç, offset

**–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞** (–¥–ª—è —Ç–∏–ø–∞ Image):

```html
<div class="logo-upload" *ngIf="watermarkConfig.type === 'image'">
  <label>–õ–æ–≥–æ—Ç–∏–ø</label>
  <input
    type="file"
    accept="image/png,image/jpeg,image/svg+xml"
    (change)="onLogoFileChange($event)"
    #logoFileInput
  />
  <button (click)="logoFileInput.click()">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>

  <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞ -->
  <div class="logo-preview" *ngIf="watermarkConfig.imageUrl">
    <img [src]="watermarkConfig.imageUrl" alt="–õ–æ–≥–æ—Ç–∏–ø" />
    <button (click)="removeLogo()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div>
```

**–ú–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏**:

```typescript
async onLogoFileChange(event: Event): Promise<void> {
  const input = event.target as HTMLInputElement;
  const file = input.files?.[0];

  if (!file) return;

  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
  if (!file.type.match(/^image\/(png|jpeg|jpg|svg\+xml)$/)) {
    this.showError('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ PNG, JPEG –∏ SVG');
    return;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
  if (file.size > 5 * 1024 * 1024) {
    this.showError('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
    return;
  }

  // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ Data URL
  const reader = new FileReader();
  reader.onload = (e) => {
    this.watermarkConfig.imageUrl = e.target?.result as string;
    this.watermarkConfig.imageFile = file;

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const img = new Image();
    img.onload = () => {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ª–æ–≥–æ—Ç–∏–ø–∞ (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
      const maxSize = 200;
      const ratio = Math.min(maxSize / img.width, maxSize / img.height);
      this.watermarkConfig.imageWidth = Math.floor(img.width * ratio);
      this.watermarkConfig.imageHeight = Math.floor(img.height * ratio);

      // –û–±–Ω–æ–≤–ª—è–µ–º preview
      this.renderWatermarkPreview();
    };
    img.src = this.watermarkConfig.imageUrl;
  };
  reader.readAsDataURL(file);
}

removeLogo(): void {
  this.watermarkConfig.imageUrl = undefined;
  this.watermarkConfig.imageFile = undefined;
  this.watermarkConfig.imageWidth = undefined;
  this.watermarkConfig.imageHeight = undefined;
  this.renderWatermarkPreview();
}
```

**–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**:

```typescript
private drawImageWatermark(
  ctx: CanvasRenderingContext2D,
  config: WatermarkConfig,
  canvasWidth: number,
  canvasHeight: number
): void {
  if (!config.imageUrl) return;

  const img = new Image();
  img.onload = () => {
    const width = config.imageWidth || img.width;
    const height = config.imageHeight || img.height;

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    const { x, y } = this.watermarkService.calculatePosition(
      config.position,
      canvasWidth,
      canvasHeight,
      width,
      height,
      20, // margin
      config.offsetX || 0,
      config.offsetY || 0
    );

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
    ctx.globalAlpha = (config.opacity || 100) / 100;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (config.rotation && config.rotation !== 0) {
      ctx.save();
      ctx.translate(x + width / 2, y + height / 2);
      ctx.rotate((config.rotation * Math.PI) / 180);
      ctx.drawImage(img, -width / 2, -height / 2, width, height);
      ctx.restore();
    } else {
      ctx.drawImage(img, x, y, width, height);
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
    ctx.globalAlpha = 1.0;
  };
  img.src = config.imageUrl;
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è**:

- –¢–∏–ø —Ñ–∞–π–ª–∞: PNG, JPEG, SVG
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã: –¥–æ 500x500px
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ (PNG, SVG)

---

## 4. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°

### 4.1 –í–∫–ª–∞–¥–∫–∞ "Watermark" (MVP)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –ú–µ–∂–¥—É "–û–±—Ä–∞–±–æ—Ç–∫–∞" –∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üíß –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ [x] –í–∫–ª—é—á–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –¢–µ–∫—Å—Ç:                                  ‚îÇ
‚îÇ [_____________________________]         ‚îÇ
‚îÇ (placeholder: "¬© 2025 –í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è")  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –ü–æ–∑–∏—Ü–∏—è:                                ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ ‚îÇ [TL]  [TC]  [TR]              ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ ‚îÇ [CL]  [C]   [CR]              ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ ‚îÇ [BL]  [BC]  [BR] ‚óÑ –≤—ã–±—Ä–∞–Ω–æ    ‚îÇ     ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [–°–±—Ä–æ—Å–∏—Ç—å]  [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]                ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–Ω–æ–ø–∫–∏ –ø–æ–∑–∏—Ü–∏–∏** (9 —à—Ç.):

- –ò–∫–æ–Ω–∫–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–µ—Ç–∫–∏
- –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è
- –ö–ª–∏–∫ –º–µ–Ω—è–µ—Ç position –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç preview

### 4.2 –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (v2)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –¢–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:                     ‚îÇ
‚îÇ [üìù Text]  [üñºÔ∏è Image]                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ –î–ª—è —Ç–∏–ø–∞ Text: ‚îÄ‚îÄ‚îÄ‚îÄ               ‚îÇ
‚îÇ –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: 32px                     ‚îÇ
‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ] (12-72)          ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –®—Ä–∏—Ñ—Ç: [Arial ‚ñº]                       ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –¶–≤–µ—Ç: [‚¨ú #FFFFFF]                      ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ –î–ª—è —Ç–∏–ø–∞ Image: ‚îÄ‚îÄ‚îÄ‚îÄ              ‚îÇ
‚îÇ [üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø]                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ ‚îÇ  [–ø—Ä–µ–≤—å—é logo]   ‚îÇ                   ‚îÇ
‚îÇ ‚îÇ     150x150      ‚îÇ                   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ –†–∞–∑–º–µ—Ä: –®–∏—Ä–∏–Ω–∞ 150px  –í—ã—Å–æ—Ç–∞ 150px     ‚îÇ
‚îÇ [‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ] [‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ]                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ‚îÄ‚îÄ‚îÄ‚îÄ             ‚îÇ
‚îÇ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: 70%                       ‚îÇ
‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ] (0-100)                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –ü–æ–≤–æ—Ä–æ—Ç: 0¬∞                            ‚îÇ
‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ] (-180 - 180)     ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ –°–º–µ—â–µ–Ω–∏–µ: X: 0px  Y: 0px               ‚îÇ
‚îÇ [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]  [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄo‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚òê –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —É–∑–æ—Ä                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 5. –ü–†–ï–î–ü–†–û–°–ú–û–¢–†

### 5.1 –û–±–ª–∞—Å—Ç—å Canvas (body-canvas)

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:

- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:
  1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `renderWatermarkPreview()`
  2. Canvas –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–º –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
  3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

**–ú–µ—Ç–æ–¥**:

```typescript
private async renderWatermarkPreview(): Promise<void> {
  if (!this.watermarkConfig.enabled || !this.imageData.current) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
    return;
  }

  // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è preview (–Ω–µ –º–µ–Ω—è–µ–º imageData.current!)
  const previewCanvas = document.createElement('canvas');
  const ctx = previewCanvas.getContext('2d')!;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  const img = new Image();
  img.onload = () => {
    previewCanvas.width = img.width;
    previewCanvas.height = img.height;

    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    ctx.drawImage(img, 0, 0);

    // –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    this.drawWatermarkOnContext(ctx, this.watermarkConfig, img.width, img.height);

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º preview –≤ body-canvas (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ imageData!)
  };
  img.src = this.imageData.current;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
private drawWatermarkOnContext(
  ctx: CanvasRenderingContext2D,
  config: WatermarkConfig,
  width: number,
  height: number
): void {
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–∞, —Ü–≤–µ—Ç–∞, –ø–æ–∑–∏—Ü–∏–∏
  // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
}
```

### 5.2 –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"

**–î–µ–π—Å—Ç–≤–∏–µ**:

- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –∫ `imageData.current` (–∏–∑–º–µ–Ω—è–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
- –î–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤ `imageData.history[]`
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `imageData.historyIndex`
- –û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (width, height, fileSize)
- –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

**–ö–æ–¥**:

```typescript
async applyWatermark(): Promise<void> {
  if (!this.watermarkConfig.enabled || !this.watermarkConfig.text) {
    return;
  }

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∫ imageData.current
  await this.performImageOperation('watermark', this.watermarkConfig);

  // –ò—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ performImageOperation()

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
  this.activeTab = 'settings';
}
```

---

## 6. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### 6.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π workflow

**–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏**:

```
1. Upload (–∑–∞–≥—Ä—É–∑–∫–∞)
2. Crop (–æ–±—Ä–µ–∑–∫–∞)
3. Edit (—Ñ–∏–ª—å—Ç—Ä—ã, –ø–æ–≤–æ—Ä–æ—Ç)
4. Watermark (–≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫) ‚óÑ –ù–û–í–ê–Ø –í–ö–õ–ê–î–ö–ê
5. Settings (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)
6. Export (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
```

**–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π**:

```typescript
interface ImageOperation {
  id: string;
  type: 'load' | 'rotate' | 'flip' | 'crop' | 'brightness' | 'contrast' | 'watermark'; // +watermark
  params: WatermarkConfig | any;
  timestamp: number;
  resultDataUrl: string;
}
```

### 6.2 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**:

1. **Debounce** –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ (300ms) - –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏–∑–º–µ—Ä–µ–Ω–∏–π —Ç–µ–∫—Å—Ç–∞ (textMetrics)
3. **OffscreenCanvas** –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
4. **Web Workers** –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —É–∑–æ—Ä)

### 6.3 –û—Ç–º–µ–Ω–∞/–ü–æ–≤—Ç–æ—Ä (Undo/Redo)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:

- –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
- `undo()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
- `redo()` –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

---

## 7. –ü–†–ï–°–ï–¢–´ –ò –®–ê–ë–õ–û–ù–´

### 7.1 –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ (v2)

**–ü—Ä–µ—Å–µ—Ç—ã**:

```typescript
const WATERMARK_PRESETS: WatermarkConfig[] = [
  {
    name: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π',
    text: '¬© 2025',
    position: 'bottom-right',
    fontSize: 24,
    fontFamily: 'Arial',
    color: '#FFFFFF',
    opacity: 70,
    rotation: 0,
  },
  {
    name: '–î–∏–∞–≥–æ–Ω–∞–ª—å',
    text: '–û–ë–†–ê–ó–ï–¶',
    position: 'center',
    fontSize: 48,
    fontFamily: 'Arial',
    color: '#FF0000',
    opacity: 30,
    rotation: -45,
  },
  {
    name: '–ê–≤—Ç–æ—Ä—Å–∫–æ–µ –ø—Ä–∞–≤–æ',
    text: '¬© –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã',
    position: 'bottom-center',
    fontSize: 18,
    fontFamily: 'Times New Roman',
    color: '#000000',
    opacity: 50,
    rotation: 0,
  },
];
```

### 7.2 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤ (v3)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:

- –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ø—Ä–µ—Å–µ—Ç"
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## 8. –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### 8.1 –ü—Ä–æ–≤–µ—Ä–∫–∏

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**:

- ‚úÖ –¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –Ω–µ –ø—É—Å—Ç–æ–π (–º–∏–Ω–∏–º—É–º 1 —Å–∏–º–≤–æ–ª)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: 100 —Å–∏–º–≤–æ–ª–æ–≤
- –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: 12-72px
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: 0-100%
- –ü–æ–≤–æ—Ä–æ—Ç: -180¬∞ –¥–æ 180¬∞

### 8.2 –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**UX –ø–æ–¥—Å–∫–∞–∑–∫–∏**:

- ‚ö†Ô∏è "–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —à—Ä–∏—Ñ—Ç –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
- ‚ÑπÔ∏è "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: –•px" (–∞–≤—Ç–æ—Ä–∞—Å—á–µ—Ç)
- ‚ö†Ô∏è "–ù–∏–∑–∫–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"

---

## 9. –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø

### 9.1 CSS –∫–ª–∞—Å—Å—ã

```scss
// –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏ Watermark
.watermark-tab {
  padding: 16px;
}

// –ß–µ–∫–±–æ–∫—Å –≤–∫–ª—é—á–µ–Ω–∏—è
.watermark-toggle {
  margin-bottom: 16px;
}

// –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
.watermark-input {
  width: 100%;
  margin-bottom: 16px;
}

// –°–µ—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–π (3x3)
.position-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}

// –ö–Ω–æ–ø–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
.position-btn {
  width: 60px;
  height: 60px;
  border: 2px solid #e0e0e0;
  background: white;
  cursor: pointer;
  transition: all 0.2s;

  &.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  &:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }
}

// –°–ª–∞–π–¥–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
.watermark-slider {
  margin-bottom: 12px;
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
.watermark-preview {
  position: relative;
  border: 1px dashed #e0e0e0;
  border-radius: 8px;
  overflow: hidden;
}
```

---

## 10. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 10.1 Unit —Ç–µ—Å—Ç—ã

**–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

1. `addWatermark()` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è
2. `calculatePosition()` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
3. `getAdaptiveFontSize()` - –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ WatermarkConfig

### 10.2 E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏

**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã**:

1. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Watermark ‚Üí –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç ‚Üí –≤—ã–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é ‚Üí –ø—Ä–∏–º–µ–Ω–∏—Ç—å
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ 9 –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
3. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å preview
4. ‚úÖ –ü–æ–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å preview
5. ‚úÖ –û—Ç–º–µ–Ω–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ —á–µ—Ä–µ–∑ Undo
6. ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä

---

## 11. –≠–¢–ê–ü–´ –†–ê–ó–†–ê–ë–û–¢–ö–ò

### 11.1 –§–∞–∑–∞ 1: MVP (2-3 –¥–Ω—è)

‚úÖ **–ó–∞–¥–∞—á–∏**:

1. –î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É "Watermark" –≤ `image-modal.component.html`
2. –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `WatermarkConfig`
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `addWatermark(dataUrl, config)`
4. UI: –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ + —Å–µ—Ç–∫–∞ 3x3 –ø–æ–∑–∏—Ü–∏–π
5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å preview canvas
6. –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"

### 11.2 –§–∞–∑–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (3-4 –¥–Ω—è)

‚≠ê **–ó–∞–¥–∞—á–∏**:

1. –°–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
2. –í—ã–±–æ—Ä —Å–µ–º–µ–π—Å—Ç–≤–∞ —à—Ä–∏—Ñ—Ç–æ–≤ (dropdown)
3. Color picker –¥–ª—è —Ü–≤–µ—Ç–∞
4. –°–ª–∞–π–¥–µ—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
5. –°–ª–∞–π–¥–µ—Ä –ø–æ–≤–æ—Ä–æ—Ç–∞
6. –†—É—á–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (offsetX, offsetY)

### 11.3 –§–∞–∑–∞ 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏ (5+ –¥–Ω–µ–π)

üöÄ **–ó–∞–¥–∞—á–∏**:

1. –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —É–∑–æ—Ä (diagonal pattern)
2. –û–±–≤–æ–¥–∫–∞/—Ç–µ–Ω—å —Ç–µ–∫—Å—Ç–∞
3. –ü—Ä–µ—Å–µ—Ç—ã —Å—Ç–∏–ª–µ–π
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
5. –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞ (image watermark)

---

## 12. –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏**: –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π Canvas API

**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**:

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

---

## 13. –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

### 13.1 –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**:

```typescript
/**
 * –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
 * @param dataUrl - Data URL –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
 * @param config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
 * @returns Promise<string> - Data URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
 * @throws Error –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
 */
private async addWatermark(dataUrl: string, config: WatermarkConfig): Promise<string>
```

### 13.2 –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°–ø—Ä–∞–≤–∫–∞ –≤ UI** (tooltip –Ω–∞ –∏–∫–æ–Ω–∫–µ ‚ÑπÔ∏è):

```
üíß –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∑–∞—â–∏—Ç—ã –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤.
–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é –∏–∑ 9 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é.
```

---

## 14. –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (Must Have - MVP):

1. ‚úÖ –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
2. ‚úÖ –í—ã–±–æ—Ä –ø–æ–∑–∏—Ü–∏–∏ (9 —Ç–æ—á–µ–∫)
3. ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
4. ‚úÖ –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç
5. ‚úÖ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –í–∞–∂–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (Should Have - v2):

6. ‚≠ê **–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å Text/Image** - –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
7. ‚≠ê **–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞** - –¥–ª—è —Ç–∏–ø–∞ Image
8. ‚≠ê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ (—Å–ª–∞–π–¥–µ—Ä)
9. ‚≠ê –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ (color picker)
10. ‚≠ê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ (—Å–ª–∞–π–¥–µ—Ä)

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (Nice to Have):

11. üöÄ –ü–æ–≤–æ—Ä–æ—Ç —Ç–µ–∫—Å—Ç–∞/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
12. üöÄ –í—ã–±–æ—Ä —Å–µ–º–µ–π—Å—Ç–≤–∞ —à—Ä–∏—Ñ—Ç–æ–≤
13. üöÄ –ü—Ä–µ—Å–µ—Ç—ã —Å—Ç–∏–ª–µ–π
14. üöÄ –†—É—á–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (offsetX, offsetY)

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (Future):

15. üíé –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —É–∑–æ—Ä (tile pattern)
16. üíé –û–±–≤–æ–¥–∫–∞/—Ç–µ–Ω—å —Ç–µ–∫—Å—Ç–∞
17. üíé –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ—Å–µ—Ç—ã –≤ localStorage
18. üíé –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SVG –ª–æ–≥–æ—Ç–∏–ø–æ–≤ —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–π

---

## 15. –†–ï–§–ï–†–ï–ù–°–ù–´–ô –ö–û–î

### 15.1 –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ—Ç–æ–¥–∞ addWatermark

**–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª**: `examples/components/advanced-image-editor/advanced-image-editor.component.ts` (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

**–ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê** (—Å–æ–≥–ª–∞—Å–Ω–æ –µ–¥–∏–Ω–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É –ø—Ä–∞–≤–¥—ã):

```typescript
/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –∫ —Ç–µ–∫—É—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
 * –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å imageData.current - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã
 * @param config - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
 */
private async applyWatermarkOperation(config: WatermarkConfig): Promise<void> {
  if (!this.imageData.current) {
    throw new Error('No image loaded');
  }

  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d')!;

      canvas.width = img.width;
      canvas.height = img.height;

      // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      ctx.drawImage(img, 0, 0);

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞
      const fontSize = config.fontSize || Math.max(24, Math.min(img.width / 20, 48));
      ctx.font = `${fontSize}px ${config.fontFamily || 'Arial'}`;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫ —Ü–≤–µ—Ç—É
      const opacity = (config.opacity || 70) / 100;
      const color = this.applyOpacityToColor(config.color || '#FFFFFF', opacity);
      ctx.fillStyle = color;
      ctx.textBaseline = 'bottom';

      // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞
      const textMetrics = ctx.measureText(config.text);
      const textWidth = textMetrics.width;
      const margin = 20;

      // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
      const { x, y } = this.calculateWatermarkPosition(
        config.position,
        canvas.width,
        canvas.height,
        textWidth,
        fontSize,
        margin
      );

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å rotation
      if (config.rotation && config.rotation !== 0) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate((config.rotation * Math.PI) / 180);
        ctx.fillText(config.text, 0, 0);
        ctx.restore();
      } else {
        ctx.fillText(config.text, x, y);
      }

      // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º imageData.current (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã!)
      this.imageData.current = canvas.toDataURL('image/png');

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
      this.updateImageMetadata(canvas.width, canvas.height);

      resolve();
    };
    img.onerror = reject;
    img.src = this.imageData.current;
  });
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
 */
private calculateWatermarkPosition(
  position: WatermarkPosition,
  canvasWidth: number,
  canvasHeight: number,
  textWidth: number,
  fontSize: number,
  margin: number
): { x: number; y: number } {
  let x: number, y: number;

  switch (position) {
    case 'top-left':
      x = margin;
      y = fontSize + margin;
      break;
    case 'top-center':
      x = (canvasWidth - textWidth) / 2;
      y = fontSize + margin;
      break;
    case 'top-right':
      x = canvasWidth - textWidth - margin;
      y = fontSize + margin;
      break;
    case 'center-left':
      x = margin;
      y = canvasHeight / 2;
      break;
    case 'center':
      x = (canvasWidth - textWidth) / 2;
      y = canvasHeight / 2;
      break;
    case 'center-right':
      x = canvasWidth - textWidth - margin;
      y = canvasHeight / 2;
      break;
    case 'bottom-left':
      x = margin;
      y = canvasHeight - margin;
      break;
    case 'bottom-center':
      x = (canvasWidth - textWidth) / 2;
      y = canvasHeight - margin;
      break;
    case 'bottom-right':
    default:
      x = canvasWidth - textWidth - margin;
      y = canvasHeight - margin;
      break;
  }

  return { x, y };
}

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫ —Ü–≤–µ—Ç—É
 */
private applyOpacityToColor(color: string, opacity: number): string {
  // –ï—Å–ª–∏ —Ü–≤–µ—Ç —É–∂–µ –≤ rgba —Ñ–æ—Ä–º–∞—Ç–µ
  if (color.startsWith('rgba')) {
    return color;
  }

  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º hex –≤ rgba
  if (color.startsWith('#')) {
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  // –ï—Å–ª–∏ rgb —Ñ–æ—Ä–º–∞—Ç
  if (color.startsWith('rgb(')) {
    return color.replace('rgb(', 'rgba(').replace(')', `, ${opacity})`);
  }

  return `rgba(255, 255, 255, ${opacity})`;
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏**:

- ‚ùå –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç dataUrl –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å `imageData.current`
- ‚ùå –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π dataUrl - –∏–∑–º–µ–Ω—è–µ—Ç `imageData.current` –Ω–∞–ø—Ä—è–º—É—é
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å–∏—Å—Ç–µ–º–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ 9 –ø–æ–∑–∏—Ü–∏–π (–≤–∫–ª—é—á–∞—è center-left, center-right, top-center, bottom-center)

### 15.2 –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ–¥—Ö–æ–¥** (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π):

```typescript
/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å")
 */
async applyWatermark(): Promise<void> {
  if (!this.watermarkConfig.text || !this.watermarkConfig.enabled) {
    return;
  }

  try {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É
    // –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
    // 1. –ü—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ imageData.current
    // 2. –î–æ–±–∞–≤–∏—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
    // 3. –û–±–Ω–æ–≤–∏—Ç historyIndex
    // 4. –û–±–Ω–æ–≤–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    await this.applyOperation('watermark', this.watermarkConfig);

    console.log(`üíß –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω: "${this.watermarkConfig.text}"`);

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
    this.activeTab = 'settings';
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:', error);
    this.showError('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞');
  }
}

/**
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
 */
resetWatermark(): void {
  this.watermarkConfig = {
    enabled: false,
    text: '',
    position: 'bottom-right',
    fontSize: 0, // 0 = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç
    fontFamily: 'Arial',
    color: '#FFFFFF',
    opacity: 70,
    rotation: 0,
    offsetX: 0,
    offsetY: 0
  };
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã**:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `applyOperation()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è `imageData.current`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Undo/Redo —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## 16. CHANGELOG

| –î–∞—Ç–∞       | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è           |
| ---------- | ------ | ------------------- |
| 14.12.2025 | 1.0    | –ù–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¢–ó |

---

**–ò–¢–û–ì–û**: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∞—Ç—å —Å MVP –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏.

**–ö–æ–Ω—Ç–∞–∫—Ç—ã**: TomashBraun1964/avrora-editor
