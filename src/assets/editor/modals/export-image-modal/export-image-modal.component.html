<div class="modal-backdrop" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-container">
    <!-- Header -->
    <div class="modal-header">
      <div class="modal-title">
        <span class="modal-icon">üì¶</span>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
      </div>
      <button class="close-btn" (click)="close()" [disabled]="isProcessing">√ó</button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <!-- File Name - Inline -->
      <div class="form-group form-group-inline">
        <label for="fileName">–ò–º—è —Ñ–∞–π–ª–∞:</label>
        <input
          type="text"
          id="fileName"
          [(ngModel)]="fileName"
          class="file-name-input"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞"
          [disabled]="isProcessing"
        />
      </div>

      <!-- Row 1: Alignment + Format + Quality -->
      <div class="form-group form-group-triple">
        <div class="alignment-section">
          <label>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:</label>
          <div class="alignment-buttons">
            <button
              class="alignment-btn mini"
              [class.active]="alignment === 'left'"
              (click)="alignment = 'left'"
              [disabled]="isProcessing"
              title="–ü–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é"
            >
              ‚¨ÖÔ∏è
            </button>
            <button
              class="alignment-btn mini"
              [class.active]="alignment === 'center'"
              (click)="alignment = 'center'"
              [disabled]="isProcessing"
              title="–ü–æ —Ü–µ–Ω—Ç—Ä—É"
            >
              ‚ÜîÔ∏è
            </button>
            <button
              class="alignment-btn mini"
              [class.active]="alignment === 'right'"
              (click)="alignment = 'right'"
              [disabled]="isProcessing"
              title="–ü–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é"
            >
              ‚û°Ô∏è
            </button>
          </div>
        </div>
        <div class="format-section">
          <label>–§–æ—Ä–º–∞—Ç:</label>
          <div class="format-buttons">
            <button
              class="format-btn mini"
              [class.active]="selectedFormat === 'jpg'"
              (click)="selectFormat('jpg')"
              [disabled]="isProcessing"
            >
              JPG
            </button>
            <button
              class="format-btn mini"
              [class.active]="selectedFormat === 'png'"
              (click)="selectFormat('png')"
              [disabled]="isProcessing"
            >
              PNG
            </button>
            <button
              class="format-btn mini"
              [class.active]="selectedFormat === 'webp'"
              (click)="selectFormat('webp')"
              [disabled]="isProcessing"
            >
              WebP
            </button>
          </div>
        </div>
        <div class="quality-section">
          <label for="quality"
            >–ö–∞—á–µ—Å—Ç–≤–æ: <span class="quality-value">{{ quality }}%</span></label
          >
          <input
            type="range"
            id="quality"
            [(ngModel)]="quality"
            (input)="onQualityChange()"
            min="1"
            max="100"
            class="quality-slider"
            [disabled]="isProcessing"
          />
        </div>
      </div>

      <!-- Container Settings Toggle -->
      <div class="form-group">
        <div class="container-toggle">
          <label class="checkbox-label container-header">
            <input
              type="checkbox"
              [(ngModel)]="useContainer"
              (change)="onContainerToggle()"
              [disabled]="isProcessing"
            />
            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)</span>
          </label>
        </div>
      </div>

      <!-- Container Settings Block -->
      <div class="container-settings-block" *ngIf="useContainer">
        <h4 class="container-settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</h4>
        <div class="container-settings">
          <!-- Mode Selector -->
          <div class="mode-selector">
            <button
              class="mode-btn"
              [class.active]="containerMode === 'custom'"
              (click)="containerMode = 'custom'; onContainerModeChange()"
              [disabled]="isProcessing"
            >
              üìè –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            </button>
            <button
              class="mode-btn"
              [class.active]="containerMode === 'aspect'"
              (click)="containerMode = 'aspect'; onContainerModeChange()"
              [disabled]="isProcessing"
            >
              üìê –§–æ—Ä–º–∞—Ç —Å—Ç–æ—Ä–æ–Ω
            </button>
          </div>

          <!-- Custom Size Mode -->
          <div class="custom-mode" *ngIf="containerMode === 'custom'">
            <div class="size-inputs-inline">
              <div class="input-group-horizontal">
                <label for="containerWidth">–®–∏—Ä–∏–Ω–∞ (px):</label>
                <input
                  type="number"
                  id="containerWidth"
                  [(ngModel)]="containerWidth"
                  (input)="onContainerSizeChange('width')"
                  min="1"
                  max="3000"
                  [disabled]="isProcessing"
                  class="size-input"
                />
              </div>

              <div class="input-group-horizontal">
                <label for="containerHeight">–í—ã—Å–æ—Ç–∞ (px):</label>
                <input
                  type="number"
                  id="containerHeight"
                  [(ngModel)]="containerHeight"
                  (input)="onContainerSizeChange('height')"
                  min="1"
                  max="3000"
                  [disabled]="isProcessing || isProportional"
                  class="size-input"
                />
              </div>

              <button
                class="lock-btn"
                [class.locked]="isProportional"
                (click)="toggleProportional()"
                [disabled]="isProcessing"
                title="{{ isProportional ? '–û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å' }}"
              >
                <span class="lock-icon">{{ isProportional ? 'üîí' : 'üîì' }}</span>
                <span class="lock-text">–ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span>
              </button>
            </div>
          </div>

          <!-- Aspect Ratio Mode -->
          <div class="aspect-mode" *ngIf="containerMode === 'aspect'">
            <!-- Aspect Ratio Presets -->
            <div class="aspect-presets">
              <button
                *ngFor="let preset of aspectRatioPresets"
                class="aspect-preset-btn"
                [class.active]="selectedAspectRatio === preset.label"
                (click)="selectAspectRatio(preset)"
                [disabled]="isProcessing"
              >
                {{ preset.label }}
              </button>
            </div>

            <!-- Dimension Selection - –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º -->
            <div class="dimension-selector">
              <div class="radio-group">
                <label class="radio-label">
                  <input
                    type="radio"
                    name="dimension"
                    value="width"
                    [(ngModel)]="aspectRatioDimension"
                    (change)="onAspectRatioDimensionChange()"
                    [disabled]="isProcessing"
                  />
                  <span>–®–∏—Ä–∏–Ω–∞ (px)</span>
                </label>
                <label class="radio-label">
                  <input
                    type="radio"
                    name="dimension"
                    value="height"
                    [(ngModel)]="aspectRatioDimension"
                    (change)="onAspectRatioDimensionChange()"
                    [disabled]="isProcessing"
                  />
                  <span>–í—ã—Å–æ—Ç–∞ (px)</span>
                </label>
              </div>

              <input
                type="number"
                [(ngModel)]="aspectRatioValue"
                (input)="onAspectRatioValueChange()"
                min="1"
                max="3000"
                class="aspect-value-input"
                [disabled]="isProcessing || !selectedAspectRatio"
                [placeholder]="
                  selectedAspectRatio
                    ? aspectRatioDimension === 'width'
                      ? '–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É'
                      : '–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É'
                    : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç'
                "
              />
            </div>
          </div>

          <!-- Object-fit Selection -->
          <div class="objectfit-section">
            <label>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:</label>
            <div class="objectfit-buttons">
              <button
                class="objectfit-btn"
                [class.active]="objectFit === 'cover'"
                (click)="selectObjectFit('cover')"
                [disabled]="isProcessing"
                title="–û–±—Ä–µ–∑–∞—Ç—å –∫—Ä–∞—è, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏"
              >
                üìê Cover
              </button>
              <button
                class="objectfit-btn"
                [class.active]="objectFit === 'fill'"
                (click)="selectObjectFit('fill')"
                [disabled]="isProcessing"
                title="–†–∞—Å—Ç—è–Ω—É—Ç—å, –º–æ–∂–µ—Ç –¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å"
              >
                ‚ö†Ô∏è Fill
              </button>
            </div>
            <div class="objectfit-warning" *ngIf="objectFit === 'fill'">
              ‚ö†Ô∏è –†–µ–∂–∏–º Fill –º–æ–∂–µ—Ç –¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            </div>
          </div>
        </div>
      </div>

      <!-- Image Info - Single Line Layout -->
      <div class="image-info compact">
        <div class="info-line single-line">
          <span class="info-item"> <strong>–†–∞–∑–º–µ—Ä:</strong> {{ imageWidth }} √ó {{ imageHeight }} px </span>
          <span class="info-separator">‚Ä¢</span>
          <span class="info-item">
            <strong>–§–æ—Ä–º–∞—Ç:</strong> {{ originalFormat }} ‚Üí {{ selectedFormat.toUpperCase() }}
          </span>
          <span class="info-separator">‚Ä¢</span>
          <span class="info-item">
            <strong>–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:</strong> {{ formattedOriginalSize }} ‚Üí
            <span class="new-size" [ngClass]="sizeDifferenceClass">
              {{ formattedFileSize }} ({{ sizeDifference }})
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="close()" [disabled]="isProcessing">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" (click)="download()" [disabled]="isProcessing">
        <span *ngIf="!isProcessing">‚úÖ –í—Å—Ç–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</span>
        <span *ngIf="isProcessing">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</span>
      </button>
    </div>
  </div>
</div>
