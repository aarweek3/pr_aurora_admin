<div class="tokens-tab-container">
  <!-- System Health Report -->
  <div class="health-alert full-width-card" *ngIf="systemHealth() as health">
    <nz-alert [nzType]="health.level" [nzMessage]="health.title" [nzDescription]="alertDesc" nzShowIcon>
      <ng-template #alertDesc>
        <div class="health-desc">
          <p>{{ health.message }}</p>
          <div class="recommendation" *ngIf="health.recommendation">
            <strong>Recommendation:</strong> {{ health.recommendation }}
          </div>
        </div>
      </ng-template>
    </nz-alert>
  </div>
  <!-- Access Token Card -->
  <nz-card [nzTitle]="'Access Token'" [nzExtra]="accessExtra" class="token-card">
    <ng-template #accessExtra>
      <nz-tag [nzColor]="tokenStatus()?.valid ? 'success' : 'error'">
        {{ tokenStatus()?.valid ? 'Валиден' : 'Истек/Отсутствует' }}
      </nz-tag>
    </ng-template>

    <div class="token-details">
      <div class="time-section">
        <div class="label-row">
          <span>Осталось времени</span>
          <span class="time-value" [style.color]="statusColor()">
            <!-- Format milliseconds to MM:ss approximately -->
            {{ tokenStatus()?.timeUntilExpiry | date : 'mm:ss' }}
            <small class="text-muted">({{ tokenStatus()?.timeUntilExpiry | number }} мс)</small>
          </span>
        </div>
        <nz-progress
          [nzPercent]="timeLeftPercent()"
          [nzShowInfo]="false"
          [nzStrokeColor]="statusColor()"
          [nzStatus]="tokenStatus()?.valid ? 'active' : 'exception'"
        >
        </nz-progress>
        <div class="expiry-date">Истекает в: {{ tokenStatus()?.expiresAt | date : 'mediumTime' }}</div>
      </div>

      <div class="claims-section" *ngIf="tokenStatus() as status">
        <h4>Данные пользователя и Роли</h4>
        <div class="claims-grid">
          <div class="claim-item">
            <span class="label">Email:</span>
            <span class="value">{{ status.userEmail || '-' }}</span>
          </div>
          <div class="claim-item">
            <span class="label">ID пользователя:</span>
            <!-- Show first chunk of ID for brevity if needed, or full -->
            <span class="value" [title]="status.userId">{{ status.userId || '-' }}</span>
          </div>
          <div class="claim-item">
            <span class="label">Роли:</span>
            <span class="value">
              <nz-tag *ngFor="let role of status.userRoles" [nzColor]="'blue'">{{ role }}</nz-tag>
              <span *ngIf="!status.userRoles?.length">-</span>
            </span>
          </div>
          <div class="claim-item" *ngIf="status.isExternalAccount">
            <span class="label">Провайдер:</span>
            <span class="value">
              <nz-tag [nzColor]="status.externalProvider === 'Google' ? 'red' : 'geekblue'">
                <span nz-icon [nzType]="status.externalProvider?.toLowerCase() || 'global'"></span>
                {{ status.externalProvider || 'External' }}
              </nz-tag>
            </span>
          </div>
          <div class="claim-item" *ngIf="!status.isExternalAccount">
            <span class="label">Тип входа:</span>
            <span class="value">
              <nz-tag [nzColor]="'default'">Внутренний / Пароль</nz-tag>
            </span>
          </div>
        </div>
      </div>

      <div class="actions-row">
        <button nz-button nzType="default" (click)="copyToken()" nz-tooltip nzTooltipTitle="Копировать JSON">
          <span nz-icon nzType="copy"></span> Копировать
        </button>
        <button nz-button nzType="default" (click)="exportData()"><span nz-icon nzType="export"></span> Экспорт</button>
      </div>
    </div>
  </nz-card>

  <!-- Refresh Token Card -->
  <nz-card [nzTitle]="'Refresh Token'" [nzExtra]="refreshExtra" class="token-card">
    <ng-template #refreshExtra>
      <!-- Refresh token status is inferred usually, hard to know client side without checking -->
      <nz-tag [nzColor]="cookieStatus()?.hasRefreshToken ? 'success' : 'warning'">
        {{ cookieStatus()?.hasRefreshToken ? 'Присутствует' : 'Не обнаружен' }}
      </nz-tag>
    </ng-template>

    <div class="token-details">
      <div class="info-block">
        <p>Refresh Token хранится в защищенной куке <strong>HttpOnly</strong>.</p>
        <p>Он недоступен для JavaScript. Статус проверяется через серверный запрос.</p>
      </div>

      <div class="refresh-stats">
        <div class="stat-row">
          <span>Всего кук:</span>
          <span>{{ cookieStatus()?.cookieCount ?? '-' }}</span>
        </div>
        <div class="stat-row">
          <span>Проверка статуса:</span>
          <nz-tag [nzColor]="cookieStatus()?.success ? 'success' : 'error'">
            {{ cookieStatus()?.success ? 'Подтверждено сервером' : 'Ошибка проверки' }}
          </nz-tag>
        </div>
        <div class="stat-row">
          <span>Refresh Кука:</span>
          <nz-tag [nzColor]="cookieStatus()?.hasRefreshToken ? 'processing' : 'default'">
            {{ cookieStatus()?.hasRefreshToken ? 'Найдена' : 'Отсутствует' }}
          </nz-tag>
        </div>
        <div class="stat-row">
          <span>Последняя проверка:</span>
          <span>{{ tokenStatus()?.lastChecked | date : 'mediumTime' }}</span>
        </div>
      </div>

      <div class="actions-row">
        <button nz-button nzType="primary" (click)="forceRefresh()">
          <span nz-icon nzType="sync"></span> Обновить принудительно
        </button>
        <button nz-button nzDanger><span nz-icon nzType="delete"></span> Отозвать токен</button>
      </div>
    </div>
  </nz-card>

  <!-- Server Validation Section -->
  <nz-card [nzTitle]="'Валидация на сервере'" [nzExtra]="validationExtra" class="full-width-card">
    <ng-template #validationExtra>
      <button nz-button nzType="text" (click)="isHelpVisible.set(true)">
        <span nz-icon nzType="question-circle"></span> Помощь
      </button>
    </ng-template>

    <div class="validation-content">
      <div class="validation-status" *ngIf="consistencyStatus() as result; else notChecked">
        <span
          nz-icon
          [nzType]="result.isConsistent ? 'check-circle' : 'warning'"
          [nzTheme]="'twotone'"
          [nzTwotoneColor]="result.isConsistent ? '#52c41a' : '#faad14'"
        ></span>
        <span>
          {{
            result.isConsistent
              ? 'Состояние клиента и сервера согласовано'
              : 'Обнаружены расхождения между клиентом и сервером'
          }}
        </span>
      </div>
      <ng-template #notChecked>
        <div class="validation-status">
          <span nz-icon nzType="info-circle" nzTheme="outline"></span>
          <span>Ожидание проверки...</span>
        </div>
      </ng-template>

      <button nz-button [nzLoading]="isCheckingConsistency()" (click)="checkConsistency()">
        Проверить согласованность
      </button>
    </div>

    <!-- Differences List -->
    <div class="differences-list" *ngIf="consistencyStatus()?.differences?.length">
      <nz-tag [nzColor]="'red'" *ngFor="let diff of consistencyStatus().differences">
        {{ diff }}
      </nz-tag>
    </div>
  </nz-card>
</div>

<!-- Help Modal -->
<nz-modal
  [nzVisible]="isHelpVisible()"
  nzTitle="Инструкция по проверке токенов"
  (nzOnCancel)="isHelpVisible.set(false)"
  (nzOnOk)="isHelpVisible.set(false)"
  [nzWidth]="700"
>
  <ng-container *nzModalContent>
    <div class="help-content">
      <h3>1. Access Token (Токен доступа)</h3>
      <p>Этот токен используется для авторизации всех API запросов.</p>
      <ul>
        <li>
          <strong>Time Remaining:</strong> Показывает, сколько времени токен еще будет валиден. Если время истекло,
          приложение попытается обновить его автоматически.
        </li>
        <li>
          <strong>User Details:</strong> Данные, зашифрованные в самом токене (Email, ID, Роли). Сервер доверяет этим
          данным, пока подпись токена валидна.
        </li>
        <li><span class="text-success">Valid</span>: Токен присутствует и срок действия не истек.</li>
        <li>
          <strong>Auth Provider:</strong> Указывает источник авторизации. "Internal" — стандартный вход по email/паролю,
          "Google/Facebook" — внешняя авторизация. Для внешних аккаунтов часть функций управления паролем может быть
          недоступна.
        </li>
      </ul>

      <h3>2. Refresh Token (Токен обновления)</h3>
      <p>Используется для получения нового Access Token, когда старый истекает.</p>
      <ul>
        <li>Хранится в <strong>HttpOnly Cookie</strong>, поэтому JavaScript не может прочитать его напрямую.</li>
        <li>
          <strong>Status Check (Server Confirmed):</strong> Мы делаем специальный запрос на сервер, чтобы он проверил
          наличие куки. Если вы видите "Found/Present", значит механизм бесшовного обновления сессии работает.
        </li>
      </ul>

      <h3>3. Server Validation (Проверка целостности)</h3>
      <p>Сравнивает то, что "думает" клиент (браузер), с тем, как "видит" вас сервер.</p>
      <ul>
        <li>
          <strong>Кнопка "Check Consistency":</strong> Отправляет ваш текущий email и список ролей на сервер. Сервер
          сравнивает их с данными из расшифрованного токена на своей стороне.
        </li>
        <li>
          <strong>Почему это важно?</strong> Если здесь есть ошибки (красный статус), значит произошла рассинхронизация.
          Например, у вас остались старые роли в памяти, хотя токен уже новый. Это может привести к ошибкам "Access
          Denied".
        </li>
      </ul>

      <div class="alert-box">
        <strong>Что делать при ошибках?</strong>
        <p>
          Нажмите <strong>Force Refresh</strong> в секции Refresh Token. Это принудительно обновит все токены и
          синхронизирует состояние.
        </p>
      </div>
    </div>
  </ng-container>
</nz-modal>
