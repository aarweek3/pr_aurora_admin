<div class="session-tab-container">
  <div class="main-info">
    <!-- User Profile Card -->
    <nz-card [nzBordered]="false" class="profile-card">
      <nz-card-meta
        [nzTitle]="titleTemplate"
        [nzDescription]="descriptionTemplate"
        [nzAvatar]="avatarTemplate"
      ></nz-card-meta>

      <ng-template #avatarTemplate>
        <nz-avatar [nzSize]="64" [nzSrc]="currentUser()?.avatar" [nzIcon]="'user'" style="background-color: #1890ff">
        </nz-avatar>
      </ng-template>

      <ng-template #titleTemplate>
        <div class="card-header">
          <h3>{{ currentUser()?.fullName || 'Гость' }}</h3>
          <nz-tag [nzColor]="isAuthenticated() ? 'success' : 'default'">
            {{ isAuthenticated() ? 'Авторизован' : 'Гость' }}
          </nz-tag>
        </div>
      </ng-template>

      <ng-template #descriptionTemplate>
        <div class="user-details">
          <p class="email">
            <span nz-icon nzType="mail"></span>
            {{ currentUser()?.email || 'No email' }}
          </p>

          <!-- Authentication Provider -->
          <p class="auth-provider" *ngIf="currentUser()">
            <span nz-icon nzType="login"></span>
            <span *ngIf="!currentUser()?.isExternalAccount" class="provider-badge email-provider">
              <span nz-icon nzType="mail"></span>
              Email/Password
            </span>
            <span
              *ngIf="currentUser()?.isExternalAccount && currentUser()?.externalProvider === 'Google'"
              class="provider-badge google-provider"
            >
              <span nz-icon nzType="google"></span>
              Google
            </span>
            <span
              *ngIf="currentUser()?.isExternalAccount && currentUser()?.externalProvider === 'Facebook'"
              class="provider-badge facebook-provider"
            >
              <span nz-icon nzType="facebook" nzTheme="fill"></span>
              Facebook
            </span>
          </p>

          <div class="roles-list">
            <nz-tag *ngFor="let role of userRoles()" [nzColor]="'blue'">
              {{ role }}
            </nz-tag>
          </div>
        </div>
      </ng-template>

      <div class="card-actions">
        <button nz-button nzType="primary" (click)="refreshSession()">
          <span nz-icon nzType="sync"></span> Обновить данные
        </button>
        <button nz-button nzDanger (click)="logout()"><span nz-icon nzType="logout"></span> Выйти из системы</button>
      </div>
    </nz-card>

    <!-- Session Stats -->
    <div class="stats-grid">
      <nz-card>
        <nz-statistic
          [nzValue]="(currentUser()?.lastLogin | date : 'shortTime') || '-'"
          [nzTitle]="'Время входа'"
          [nzPrefix]="prefixLogin"
        >
        </nz-statistic>
        <ng-template #prefixLogin><span nz-icon nzType="login"></span></ng-template>
      </nz-card>

      <nz-card>
        <nz-statistic [nzValue]="'2ч 15м'" [nzTitle]="'Длительность'" [nzPrefix]="prefixClock"> </nz-statistic>
        <ng-template #prefixClock><span nz-icon nzType="clock-circle"></span></ng-template>
      </nz-card>
    </div>

    <nz-card [nzTitle]="providerTitle" class="provider-audit-card" *ngIf="currentUser()">
      <ng-template #providerTitle>
        <div class="card-header">
          <div class="header-main">
            <span nz-icon nzType="safety-certificate" nzTheme="twotone"></span> Аудит внешних провайдеров
          </div>
          <div class="header-actions">
            <!-- Quick Help -->
            <span
              nz-icon
              nzType="question-circle"
              nzTheme="outline"
              class="help-icon"
              nz-popover
              nzPopoverTitle="Provider Guide"
              [nzPopoverContent]="provHelpTpl"
              nzPopoverPlacement="bottomRight"
            ></span>

            <!-- Russian Expanded Help -->
            <span
              nz-icon
              nzType="info-circle"
              nzTheme="twotone"
              class="help-icon"
              nz-popover
              nzPopoverTitle="Об Аудите Провайдеров"
              [nzPopoverContent]="provHelpRuTpl"
              nzPopoverPlacement="bottomRight"
            ></span>
          </div>
        </div>
      </ng-template>

      <ng-template #provHelpTpl>
        <div class="simulator-help">
          <p>Tracks connection to external identity providers like Google or Facebook.</p>
          <p><strong>Fields:</strong></p>
          <ul>
            <li><code>External ID</code> - Unique identifier from the provider (e.g., Google sub).</li>
            <li><code>Unlink</code> - Removes the provider link and converts account to local.</li>
          </ul>
        </div>
      </ng-template>

      <ng-template #provHelpRuTpl>
        <div class="simulator-help ru">
          <p><strong>Аудит провайдеров</strong> — это панель управления вашими связанными аккаунтами.</p>
          <div class="help-features">
            <div class="feature-item">
              <span nz-icon nzType="safety" class="success-icon"></span>
              <span><strong>Безопасность:</strong> Вы видите точный ID, по которому вас узнает система.</span>
            </div>
            <div class="feature-item">
              <span nz-icon nzType="disconnect" class="success-icon"></span>
              <span><strong>Гибкость:</strong> Можно «отвязать» соцсеть и оставить только вход по паролю.</span>
            </div>
          </div>
          <p class="description">Это позволяет тестировать миграцию пользователей и корректность OAuth-связок.</p>
        </div>
      </ng-template>

      <div class="provider-status-grid">
        <!-- Linked State -->
        <div class="provider-item linked" *ngIf="currentUser()?.isExternalAccount">
          <div class="provider-info">
            <div class="provider-type">
              <span nz-icon [nzType]="currentUser()?.externalProvider === 'Google' ? 'google' : 'facebook'"></span>
              <span class="name">{{ currentUser()?.externalProvider }}</span>
              <nz-tag nzColor="success">Связано</nz-tag>
            </div>
            <div class="external-id">
              <span class="label">External ID:</span>
              <code>{{ currentUser()?.externalId || 'Unknown' }}</code>
            </div>
          </div>
          <div class="provider-actions">
            <button
              nz-button
              nzType="default"
              nzDanger
              nz-popconfirm
              nzPopconfirmTitle="Вы уверены, что хотите разорвать связь с этим аккаунтом? Вам потребуется основной пароль для входа."
              (nzOnConfirm)="unlinkExternalAccount(currentUser()?.externalProvider!)"
            >
              <span nz-icon nzType="disconnect"></span> Разрыв связи
            </button>
          </div>
        </div>

        <!-- Not Linked State (Email) -->
        <div class="provider-item empty" *ngIf="!currentUser()?.isExternalAccount">
          <span nz-icon nzType="info-circle" class="info-icon"></span>
          <div class="empty-text">
            <h4>Локальный аккаунт</h4>
            <p>Внешние провайдеры не подключены. Вы используете стандартную авторизацию (Email/Password).</p>
          </div>
        </div>
      </div>
    </nz-card>
  </div>

  <!-- Timeline Side -->
  <div class="timeline-section">
    <nz-card [nzTitle]="'События сессии'" [nzBordered]="false" class="timeline-card">
      <nz-list [nzDataSource]="sessionEvents()" [nzRenderItem]="item" [nzItemLayout]="'horizontal'">
        <ng-template #item let-item>
          <nz-list-item>
            <nz-list-item-meta [nzTitle]="item.type | titlecase" [nzDescription]="item.message">
              <nz-list-item-meta-avatar>
                <div class="event-icon" [class]="item.status">
                  <span nz-icon [nzType]="item.status === 'success' ? 'check-circle' : 'info-circle'"></span>
                </div>
              </nz-list-item-meta-avatar>
            </nz-list-item-meta>
            <div>{{ item.timestamp | date : 'HH:mm:ss' }}</div>
          </nz-list-item>
        </ng-template>
      </nz-list>
    </nz-card>
  </div>
</div>
