<div class="av-icon-settings-control" [class.compact]="compact()">
  <!-- Message Feedback -->
  @if (message()) {
  <div class="message-feedback">{{ message() }}</div>
  }

  <!-- Block A: Selection & Reset -->
  <av-field-group label="Выбор иконки" size="small" [collapsible]="false">
    <div class="selection-row">
      <nz-select
        [ngModel]="value().type"
        (ngModelChange)="updateProperty('type', $event)"
        nzShowSearch
        nzSize="large"
        [nzCustomTemplate]="selectedIconTpl"
        [nzDropdownStyle]="{ 'max-height': '500px' }"
        class="icon-select"
      >
        @for (preset of presets(); track preset.value) {
        <nz-option nzCustomContent [nzValue]="preset.value" [nzLabel]="preset.label">
          <div class="icon-option">
            <av-icon [type]="preset.value" [size]="16"></av-icon>
            <div class="icon-option-text">
              <span class="icon-label">{{ preset.label }}</span>
              <span class="icon-category">{{ preset.category }}</span>
            </div>
          </div>
        </nz-option>
        }
      </nz-select>

      <button av-button avType="text" avSize="small" avTextColor="#f43f5e" (click)="resetSettings()">
        <av-icon type="actions/av_close" [size]="12"></av-icon>
        Сброс
      </button>

      <ng-template #selectedIconTpl let-selected>
        <div class="selected-icon">
          <av-icon [type]="selected.nzValue" [size]="16" color="#1890ff"></av-icon>
          <span>{{ selected.nzLabel }}</span>
        </div>
      </ng-template>
    </div>
  </av-field-group>

  <!-- Block B: Geometry & Color -->
  <av-field-group label="Размер и цвет" size="small" [collapsible]="true">
    <!-- Size -->
    <div class="control-row">
      <label class="control-label">Размер:</label>
      <div class="control-slider">
        <nz-slider
          [ngModel]="value().size"
          (ngModelChange)="updateProperty('size', $event)"
          [nzMin]="8"
          [nzMax]="128"
          [nzStep]="2"
        ></nz-slider>
      </div>
      <nz-input-number
        [ngModel]="value().size"
        (ngModelChange)="updateProperty('size', $event)"
        [nzMin]="8"
        [nzMax]="128"
        [nzStep]="2"
        nzSize="small"
        class="control-number"
      ></nz-input-number>
      <div class="size-preset-buttons">
        @for (size of sizePresets; track size) {
        <button
          av-button
          avType="text"
          avSize="small"
          (click)="selectSizePreset(size)"
          [class.active]="value().size === size"
          class="preset-btn"
        >
          {{ size }}
        </button>
        }
      </div>
    </div>

    <!-- Color -->
    <div class="control-row">
      <label class="control-label">Цвет:</label>
      <nz-color-picker
        [ngModel]="value().color"
        (ngModelChange)="updateProperty('color', $event)"
        nzSize="small"
      ></nz-color-picker>
      <div class="color-preset-grid all-colors">
        @for (color of colorPresets; track $index) {
        <button
          class="color-preset-btn"
          [style.background-color]="color"
          [class.active]="value().color === color"
          (click)="selectColorPreset(color)"
        ></button>
        } @for (color of neutralColorPresets; track $index) {
        <button
          class="color-preset-btn neutral"
          [style.background-color]="color"
          [class.active]="value().color === color"
          (click)="selectColorPreset(color)"
        ></button>
        }
      </div>
      <button av-button avType="text" avSize="small" (click)="resetColor()" class="reset-color-btn">Сброс</button>
    </div>
  </av-field-group>

  <av-field-group label="Трансформации" size="small" [collapsible]="true">
    <div nz-row [nzGutter]="16">
      <!-- Rotation -->
      <div nz-col [nzXs]="24" [nzSm]="12">
        <div class="control-item">
          <label class="slider-label">Поворот:</label>
          <div class="slider-with-input">
            <nz-slider
              [ngModel]="value().rotation"
              (ngModelChange)="updateProperty('rotation', $event)"
              [nzMin]="0"
              [nzMax]="360"
              [nzStep]="1"
            ></nz-slider>
            <nz-input-number
              [ngModel]="value().rotation"
              (ngModelChange)="updateProperty('rotation', $event)"
              [nzMin]="0"
              [nzMax]="360"
              nzSize="small"
              class="mini-input"
            ></nz-input-number>
          </div>
        </div>
      </div>

      <!-- Scale -->
      <div nz-col [nzXs]="24" [nzSm]="12">
        <div class="control-item">
          <label class="slider-label">Масштаб:</label>
          <div class="slider-with-input">
            <nz-slider
              [ngModel]="value().scale"
              (ngModelChange)="updateProperty('scale', $event)"
              [nzMin]="0.1"
              [nzMax]="5"
              [nzStep]="0.1"
            ></nz-slider>
            <nz-input-number
              [ngModel]="value().scale"
              (ngModelChange)="updateProperty('scale', $event)"
              [nzMin]="0.1"
              [nzMax]="5"
              [nzStep]="0.1"
              nzSize="small"
              class="mini-input"
            ></nz-input-number>
          </div>
        </div>
      </div>
    </div>

    <div nz-row [nzGutter]="16" style="margin-top: 8px">
      <!-- Opacity -->
      <div nz-col [nzXs]="24" [nzSm]="12">
        <div class="control-item">
          <label class="slider-label">Прозрачность:</label>
          <div class="slider-with-input">
            <nz-slider
              [ngModel]="value().opacity"
              (ngModelChange)="updateProperty('opacity', $event)"
              [nzMin]="0.1"
              [nzMax]="1"
              [nzStep]="0.1"
            ></nz-slider>
            <nz-input-number
              [ngModel]="value().opacity"
              (ngModelChange)="updateProperty('opacity', $event)"
              [nzMin]="0.1"
              [nzMax]="1"
              [nzStep]="0.1"
              nzSize="small"
              class="mini-input"
            ></nz-input-number>
          </div>
        </div>
      </div>

      <!-- Flip Switches -->
      <div nz-col [nzXs]="24" [nzSm]="12">
        <div class="control-row flip-row">
          <label class="control-label">Отразить:</label>
          <div class="flip-unit">
            <span class="flip-tag">X</span>
            <nz-switch
              [ngModel]="value().flipX"
              (ngModelChange)="updateProperty('flipX', $event)"
              nzSize="small"
            ></nz-switch>
          </div>
          <div class="flip-unit">
            <span class="flip-tag">Y</span>
            <nz-switch
              [ngModel]="value().flipY"
              (ngModelChange)="updateProperty('flipY', $event)"
              nzSize="small"
            ></nz-switch>
          </div>
        </div>
      </div>
    </div>
  </av-field-group>

  <!-- Block D: Styling -->
  <av-field-group label="Стилизация" size="small" [collapsible]="true">
    <div nz-row [nzGutter]="12" nzAlign="middle">
      <!-- Padding -->
      <div nz-col [nzXs]="24" [nzSm]="10">
        <div class="control-compact">
          <label style="min-width: 50px">Отступы:</label>
          <nz-slider
            [ngModel]="value().padding"
            (ngModelChange)="updateProperty('padding', $event)"
            [nzMin]="0"
            [nzMax]="64"
            [nzStep]="1"
            style="flex: 1"
          ></nz-slider>
          <nz-input-number
            [ngModel]="value().padding"
            (ngModelChange)="updateProperty('padding', $event)"
            [nzMin]="0"
            [nzMax]="64"
            nzSize="small"
            style="width: 48px; border: none; background: transparent; box-shadow: none"
          ></nz-input-number>
        </div>
      </div>

      <!-- Background Color -->
      <div nz-col [nzXs]="12" [nzSm]="6">
        <div class="control-compact" style="justify-content: center">
          <label>Фон:</label>
          <nz-color-picker
            [ngModel]="value().background"
            (ngModelChange)="updateProperty('background', $event)"
            nzSize="small"
            nzAllowClear
          ></nz-color-picker>
        </div>
      </div>

      <!-- Border Toggle -->
      <div nz-col [nzXs]="12" [nzSm]="8">
        <div class="control-compact" style="justify-content: flex-end">
          <label>Граница:</label>
          <nz-switch
            [ngModel]="value().borderShow"
            (ngModelChange)="updateProperty('borderShow', $event)"
            nzSize="small"
          ></nz-switch>
        </div>
      </div>
    </div>

    <!-- Border Settings (conditional) -->
    @if (value().borderShow) {
    <div class="border-settings">
      <div nz-row [nzGutter]="12">
        <div nz-col [nzSpan]="8">
          <div class="control-item-mini">
            <label>Цвет:</label>
            <nz-color-picker
              [ngModel]="value().borderColor"
              (ngModelChange)="updateProperty('borderColor', $event)"
              nzSize="small"
            ></nz-color-picker>
          </div>
        </div>
        <div nz-col [nzSpan]="8">
          <div class="control-item-mini">
            <label>Толщина:</label>
            <nz-slider
              [ngModel]="value().borderWidth"
              (ngModelChange)="updateProperty('borderWidth', $event)"
              [nzMin]="1"
              [nzMax]="10"
              [nzStep]="1"
            ></nz-slider>
          </div>
        </div>
        <div nz-col [nzSpan]="8">
          <div class="control-item-mini">
            <label>Радиус:</label>
            <nz-slider
              [ngModel]="value().borderRadius"
              (ngModelChange)="updateProperty('borderRadius', $event)"
              [nzMin]="0"
              [nzMax]="24"
              [nzStep]="2"
            ></nz-slider>
          </div>
        </div>
      </div>
    </div>
    }
  </av-field-group>
</div>
